# Reverse Proxy and CORS Configuration

This document explains the reverse proxy and CORS configuration for the SAS Scuba application.

## Overview

The application has been configured to work properly behind a reverse proxy (e.g., Nginx, Apache, Cloudflare, etc.). This includes proper handling of proxy headers, CORS configuration, and Sanctum authentication.

## Changes Made

### 1. TrustProxies Middleware (`app/Http/Middleware/TrustProxies.php`)

Created a new middleware to trust all proxy headers:
- `X-Forwarded-For` - Client IP address
- `X-Forwarded-Host` - Original host
- `X-Forwarded-Port` - Original port
- `X-Forwarded-Proto` - Original protocol (http/https)
- `X-Forwarded-AWS-ELB` - AWS ELB specific headers

This middleware is registered in `bootstrap/app.php` and must be first in the middleware stack.

### 2. CORS Configuration (`config/cors.php`)

Updated to support:
- Multiple allowed origins via environment variables
- Configurable CORS max age
- Exposed headers for authentication tokens
- Pattern-based origin matching for subdomains

**Environment Variables:**
- `FRONTEND_URL` - Primary frontend URL
- `APP_URL` - Application URL (also added to CORS)
- `CORS_ALLOWED_ORIGINS` - Comma-separated list of additional allowed origins
- `CORS_ALLOWED_ORIGIN_PATTERN` - Regex pattern for dynamic origin matching
- `CORS_MAX_AGE` - CORS preflight cache duration (default: 86400 seconds)

### 3. Sanctum Configuration (`config/sanctum.php`)

Updated to properly handle stateful domains with:
- Better filtering of empty values
- Support for environment-based configuration

**Environment Variable:**
- `SANCTUM_STATEFUL_DOMAINS` - Comma-separated list of domains that should receive stateful authentication cookies

### 4. SecurityHeaders Middleware (`app/Http/Middleware/SecurityHeaders.php`)

Updated to:
- Detect HTTPS from reverse proxy headers (`X-Forwarded-Proto`)
- Support multiple frontend URLs in Content Security Policy
- Work correctly behind reverse proxies

## Environment Configuration

### Required Environment Variables

Add these to your `.env` file:

```env
# Application URL (should be the public URL, not internal)
APP_URL=https://api.yourdomain.com

# Frontend URL (where your Next.js app is hosted)
FRONTEND_URL=https://app.yourdomain.com

# Additional CORS origins (comma-separated, optional)
CORS_ALLOWED_ORIGINS=https://app.yourdomain.com,https://www.yourdomain.com

# Sanctum stateful domains (comma-separated)
SANCTUM_STATEFUL_DOMAINS=app.yourdomain.com,www.yourdomain.com,localhost,localhost:3000

# CORS max age in seconds (optional, default: 86400)
CORS_MAX_AGE=86400
```

### Frontend Configuration

In your Next.js application (`.env.local` or `.env`):

```env
NEXT_PUBLIC_API_URL=https://api.yourdomain.com
```

## Reverse Proxy Setup Examples

### Nginx Configuration

```nginx
server {
    listen 80;
    server_name api.yourdomain.com;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_set_header X-Forwarded-Host $host;
        
        # WebSocket support (if needed)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

### Apache Configuration

```apache
<VirtualHost *:80>
    ServerName api.yourdomain.com
    
    ProxyPreserveHost On
    ProxyPass / http://127.0.0.1:8000/
    ProxyPassReverse / http://127.0.0.1:8000/
    
    # Forward proxy headers
    RequestHeader set X-Forwarded-Proto "http"
    RequestHeader set X-Forwarded-Port "80"
</VirtualHost>
```

### Cloudflare Proxy

If using Cloudflare's proxy:
1. Ensure "SSL/TLS encryption mode" is set to "Full" or "Full (strict)"
2. The `X-Forwarded-Proto` header will be automatically set by Cloudflare
3. Make sure your `APP_URL` uses `https://` if Cloudflare is handling SSL

## Testing

### Test CORS Configuration

1. Open browser developer tools
2. Make a request from your frontend to the API
3. Check the Network tab for CORS headers:
   - `Access-Control-Allow-Origin` should match your frontend URL
   - `Access-Control-Allow-Credentials` should be `true`
   - `Access-Control-Expose-Headers` should include `X-XSRF-TOKEN`

### Test Reverse Proxy

1. Check that `$request->secure()` returns `true` when accessing via HTTPS through proxy
2. Verify that `$request->ip()` returns the correct client IP (not the proxy IP)
3. Ensure URLs generated by Laravel use the correct protocol and domain

### Common Issues

**Issue: CORS errors in browser**
- Solution: Ensure `FRONTEND_URL` matches exactly (including protocol and port)
- Check that `CORS_ALLOWED_ORIGINS` includes all necessary origins

**Issue: Authentication cookies not working**
- Solution: Verify `SANCTUM_STATEFUL_DOMAINS` includes your frontend domain
- Ensure cookies are being sent (check `withCredentials: true` in frontend)

**Issue: URLs generated with wrong protocol**
- Solution: Set `APP_URL` correctly and ensure TrustProxies middleware is registered
- Check that reverse proxy is forwarding `X-Forwarded-Proto` header

**Issue: Client IP is proxy IP**
- Solution: Ensure TrustProxies middleware is configured and registered
- Verify reverse proxy is sending `X-Forwarded-For` header

## Security Considerations

1. **Trust Proxies**: The current configuration trusts all proxies (`at: '*'`). In production, you may want to restrict this to specific proxy IPs:
   ```php
   $middleware->trustProxies(at: ['192.168.1.1', '10.0.0.1']);
   ```

2. **CORS Origins**: Only add trusted origins to `CORS_ALLOWED_ORIGINS`. Never use wildcards (`*`) when `supports_credentials` is `true`.

3. **HTTPS**: Always use HTTPS in production. The application will automatically set HSTS headers when behind a secure proxy.

## Additional Resources

- [Laravel TrustProxies Documentation](https://laravel.com/docs/11.x/requests#configuring-trusted-proxies)
- [Laravel CORS Documentation](https://laravel.com/docs/11.x/sanctum#cors-and-cookies)
- [Sanctum SPA Authentication](https://laravel.com/docs/11.x/sanctum#spa-authentication)

